<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Market Dashboard</title>

  <style>
    :root{
      --bg:#0b0f10;
      --card:rgba(255,255,255,0.04);
      --border:rgba(255,255,255,0.12);
      --mint:#8fffe2;
      --text:#d7e7e2;
      --muted:rgba(215,231,226,0.65);
      --bad:#ff6b6b;
      --good:#43f5c2;
    }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    }
    .container{max-width:1250px;margin:0 auto;padding:28px 16px 70px;}
    h1{text-align:center;color:var(--mint);margin:8px 0;font-size:44px;letter-spacing:.5px;}
    .subtitle{text-align:center;margin:0 0 22px;color:var(--muted);}
    .section{
      margin:16px 0;padding:18px;border-radius:18px;background:var(--card);
      border:1px solid var(--border);box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .section h2{margin:0 0 12px;font-size:26px;color:#e9fffa;text-align:center;}

    /* Picks */
    .pager{display:flex;gap:12px;align-items:center;justify-content:center;margin:10px 0 16px;flex-wrap:wrap;}
    .pager button{
      padding:8px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06);color:#d8fff2;cursor:pointer;
    }
    .pager button:disabled{opacity:.4;cursor:not-allowed;}
    .charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    .chart-card{
      border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);padding:10px;
    }
    .chart-title{display:flex;justify-content:space-between;align-items:center;font-weight:800;margin:0 0 8px;color:var(--mint);}
    .chart-box{
      width:100%;
      height:320px;
      position:relative;
      border-radius:12px;
      overflow:hidden;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
    }
    .chart-box iframe{width:100% !important;height:100% !important;display:block;}

    /* Macro */
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px;}

    /* Sector Strength */
    .sector-wrap{display:grid;grid-template-columns:1.25fr .75fr;gap:14px;align-items:start;}
    .sector-card{
      border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);padding:12px;
    }
    .sector-meta{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;color:var(--muted);font-size:13px;margin-top:8px;}
    .sector-canvas{
      width:100%;height:420px;display:block;border-radius:12px;background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.08);
    }
    .rank-title{font-weight:800;color:#e9fffa;margin:0 0 8px;text-align:center;}
    .rank-box{display:grid;grid-template-columns:1fr;gap:10px;}
    .rank-list{border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px 12px;background:rgba(0,0,0,.18);}
    .rank-list h3{margin:0 0 8px;font-size:14px;color:#e9fffa;text-align:left;}
    .rank-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,.10);font-size:13px;}
    .rank-item:last-child{border-bottom:none;}
    .pos{color:var(--good);font-weight:700;}
    .neg{color:var(--bad);font-weight:700;}

    @media (max-width:980px){
      .charts-grid{grid-template-columns:1fr;}
      .two-col{grid-template-columns:1fr;}
      .sector-wrap{grid-template-columns:1fr;}
      .chart-box{height:360px;}
      .sector-canvas{height:420px;}
      h1{font-size:34px;}
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Market Dashboard</h1>
    <div class="subtitle">Daily scan picks + sector relative strength + macro snapshot</div>

    <!-- ===== Sector Relative Strength ===== -->
    <div class="section">
      <h2>Sector Relative Strength (Sector / SPY)</h2>
      <div class="sector-wrap">
        <div class="sector-card">
          <canvas id="sectorCanvas" class="sector-canvas"></canvas>
          <div class="sector-meta">
            <span id="sectorStatus">Loading sector data...</span>
            <span>Lookback: <b>~120 trading days</b></span>
            <span>Ranking window: <b>5 trading days</b></span>
          </div>
        </div>

        <div class="sector-card">
          <div class="rank-title">Top / Bottom Sectors (5D vs SPY)</div>
          <div class="rank-box">
            <div class="rank-list">
              <h3>Top 3</h3>
              <div id="top3"></div>
            </div>
            <div class="rank-list">
              <h3>Bottom 3</h3>
              <div id="bottom3"></div>
            </div>
          </div>
          <div class="sector-meta" style="justify-content:flex-start;margin-top:10px;">
            <span style="opacity:.85">Method: compute (Sector/SPY) index, rank by 5D % change.</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Picks ===== -->
    <div class="section">
      <h2>My Picks Charts (6 per page)</h2>
      <div class="pager">
        <button id="prevPage" type="button">Prev</button>
        <div id="pageInfo">Loading picks.json...</div>
        <button id="nextPage" type="button">Next</button>
      </div>
      <div id="chartsGrid" class="charts-grid"></div>
    </div>

    <!-- ===== Macro ===== -->
    <div class="section">
      <h2>Macro Snapshot</h2>
      <div class="two-col">
        <div class="chart-card">
          <div class="chart-title"><span>Fed Funds Rate</span><span style="opacity:.75;font-weight:600;">1D</span></div>
          <div class="chart-box" id="fedFunds"></div>
        </div>
        <div class="chart-card">
          <div class="chart-title"><span>US CPI</span><span style="opacity:.75;font-weight:600;">1D</span></div>
          <div class="chart-box" id="cpi"></div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>NVDA Chart</h2>
      <div class="chart-card">
        <div class="chart-title"><span>NVDA</span><span style="opacity:.75;font-weight:600;">1D</span></div>
        <div class="chart-box" id="nvda"></div>
      </div>
    </div>

    <div class="section">
      <h2>Market Heatmap</h2>
      <div id="heatmap"></div>
    </div>
  </div>

  <!-- ===== TradingView helpers (稳定写法：script 放到 container 里，不用 container_id) ===== -->
  <script>
    function mountTVAdvancedChart(containerEl, symbol, height=320){
      const s = document.createElement("script");
      s.src = "https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js";
      s.async = true;
      s.textContent = JSON.stringify({
        width: "100%",
        height: "100%",
        symbol: symbol,
        interval: "D",
        timezone: "Etc/UTC",
        theme: "dark",
        style: "1",
        locale: "en",
        hide_top_toolbar: true,
        hide_legend: true,
        allow_symbol_change: false,
        save_image: false,
        withdateranges: false
      });
      containerEl.style.height = height + "px";
      containerEl.appendChild(s);
    }

    function mountTVHeatmap(containerEl){
      const s = document.createElement("script");
      s.src = "https://s3.tradingview.com/external-embedding/embed-widget-stock-heatmap.js";
      s.async = true;
      s.textContent = JSON.stringify({
        dataSource: "SPX500",
        blockSize: "market_cap_basic",
        blockColor: "change",
        locale: "en",
        colorTheme: "dark",
        hasTopBar: false,
        isDataSetEnabled: false,
        isZoomEnabled: true,
        hasSymbolTooltip: true,
        width: "100%",
        height: 400
      });
      containerEl.appendChild(s);
    }

    document.addEventListener("DOMContentLoaded", () => {
      mountTVAdvancedChart(document.getElementById("fedFunds"), "FRED:EFFR", 320);
      mountTVAdvancedChart(document.getElementById("cpi"), "ECONOMICS:USCPI", 320);
      mountTVAdvancedChart(document.getElementById("nvda"), "NASDAQ:NVDA", 520);
      mountTVHeatmap(document.getElementById("heatmap"));
    });
  </script>

  <!-- ===== Picks (6 per page) ===== -->
  <script>
    (function(){
      const PAGE_SIZE = 6;
      let allTickers = [];
      let page = 1;

      function $(id){ return document.getElementById(id); }
      function clearNode(el){ while(el && el.firstChild) el.removeChild(el.firstChild); }

      function renderPage(){
        const grid = $("chartsGrid");
        const info = $("pageInfo");
        const prevBtn = $("prevPage");
        const nextBtn = $("nextPage");
        if(!grid || !info || !prevBtn || !nextBtn) return;

        const totalPages = Math.max(1, Math.ceil(allTickers.length / PAGE_SIZE));
        page = Math.min(Math.max(1, page), totalPages);

        const start = (page - 1) * PAGE_SIZE;
        const items = allTickers.slice(start, start + PAGE_SIZE);

        info.textContent = `Page ${page} / ${totalPages} | Total: ${allTickers.length}`;
        prevBtn.disabled = (page <= 1);
        nextBtn.disabled = (page >= totalPages);

        clearNode(grid);

        items.forEach(t => {
          const card = document.createElement("div");
          card.className = "chart-card";

          const title = document.createElement("div");
          title.className = "chart-title";
          title.innerHTML = `<span>${t}</span><span style="opacity:.75;font-weight:600;">1D</span>`;

          const box = document.createElement("div");
          box.className = "chart-box";

          card.appendChild(title);
          card.appendChild(box);
          grid.appendChild(card);

          // 关键：把 TV widget 挂到 box 内部
          mountTVAdvancedChart(box, t, 320);
        });
      }

      async function loadPicks(){
        try{
          const r = await fetch("./picks.json?v=" + Date.now());
          const j = await r.json();
          const results = j.results || [];
          allTickers = results.map(x => (typeof x === "string" ? x : x.ticker)).filter(Boolean);
          renderPage();
        }catch(e){
          console.error(e);
          const info = $("pageInfo");
          if(info) info.textContent = "Failed to load picks.json (check Console).";
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        $("prevPage").addEventListener("click", () => { page--; renderPage(); });
        $("nextPage").addEventListener("click", () => { page++; renderPage(); });
        loadPicks();
      });
    })();
  </script>

  <!-- ===== Sector Relative Strength (TwelveData + cache) ===== -->
  <script>
    (function(){
      // ✅ 你的 TwelveData key（暂时放前端，后面可改为 scan.py 生成 JSON）
      const TWELVE_KEY = "5528eb633fd71ac2cdff279205b7064b";

      const BASE = "SPY";
      const SECTORS = [
        { t:"XLE", label:"Energy" },
        { t:"XLB", label:"Materials" },
        { t:"XLI", label:"Industrials" },
        { t:"XLF", label:"Financials" },
        { t:"XLK", label:"Technology" },
        { t:"XLV", label:"Health Care" },
        { t:"XLY", label:"Consumer Discr." },
        { t:"XLP", label:"Consumer Staples" },
        { t:"XLU", label:"Utilities" },
        { t:"XLRE", label:"Real Estate" },
        { t:"XLC", label:"Comm Services" }
      ];

      const PLOT_POINTS = 120;        // 画最近120个交易日
      const RANK_WINDOW = 5;          // 排名窗口 5天
      const FETCH_POINTS = 170;       // 多取一些，防止缺失
      const CACHE_KEY = "sector_rs_cache_v1";

      const COLORS = [
        "#7BDFF2","#B2F7EF","#EFF7F6","#F7D6E0","#F2B5D4",
        "#F8C0C8","#C3FBD8","#B5F2E2","#A9DEF9","#E4C1F9",
        "#FFCAD4","#D4A5A5"
      ];

      function $(id){ return document.getElementById(id); }
      function pctChange(a,b){ return (b && b!==0) ? (a/b - 1) : 0; }

      function setStatus(msg){ $("sectorStatus").textContent = msg; }

      async function fetchTD(symbol){
        const url =
          `https://api.twelvedata.com/time_series?symbol=${encodeURIComponent(symbol)}` +
          `&interval=1day&outputsize=${FETCH_POINTS}&format=JSON&apikey=${TWELVE_KEY}`;
        const r = await fetch(url);
        const j = await r.json();
        if(j.status === "error") throw new Error(symbol + ": " + (j.message || "error"));
        if(!j.values || !Array.isArray(j.values)) throw new Error(symbol + ": no values");
        // values are newest first
        const arr = j.values
          .map(v => ({ date: v.datetime, close: parseFloat(v.close) }))
          .filter(v => v.date && Number.isFinite(v.close))
          .reverse(); // oldest -> newest
        return arr;
      }

      function alignByDate(seriesMap){
        const keys = Object.keys(seriesMap);
        const sets = keys.map(k => new Set(seriesMap[k].map(p => p.date)));
        let dates = [...sets[0]];
        for(let i=1;i<sets.length;i++){
          dates = dates.filter(d => sets[i].has(d));
        }
        dates.sort();
        // take last PLOT_POINTS (but leave head room)
        if(dates.length > (PLOT_POINTS + 10)) dates = dates.slice(dates.length - (PLOT_POINTS + 10));

        const aligned = {};
        for(const k of keys){
          const m = new Map(seriesMap[k].map(p => [p.date, p.close]));
          aligned[k] = dates.map(d => ({ date: d, close: m.get(d) }));
        }
        return { dates, aligned };
      }

      function buildRatioIndex(sec, spy){
        const n = Math.min(sec.length, spy.length);
        const ratio = [];
        for(let i=0;i<n;i++){
          ratio.push({ date: sec[i].date, v: sec[i].close / spy[i].close });
        }
        const sliced = ratio.slice(Math.max(0, ratio.length - PLOT_POINTS));
        const base = sliced[0]?.v || 1;
        return sliced.map(p => ({ date: p.date, v: (p.v / base) * 100 }));
      }

      function renderTopBottom(changes){
        const sorted = [...changes].sort((a,b) => b.chg - a.chg);
        const top = sorted.slice(0,3);
        const bottom = sorted.slice(-3).reverse();

        function rowHTML(x){
          const cls = x.chg >= 0 ? "pos" : "neg";
          const pct = (x.chg * 100).toFixed(2) + "%";
          return `<div class="rank-item"><span>${x.t} <span style="opacity:.7">(${x.label})</span></span><span class="${cls}">${pct}</span></div>`;
        }
        $("top3").innerHTML = top.map(rowHTML).join("");
        $("bottom3").innerHTML = bottom.map(rowHTML).join("");
      }

      function drawChart(seriesList){
        const canvas = $("sectorCanvas");
        const ctx = canvas.getContext("2d");
        const rect = canvas.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        canvas.width = Math.floor(rect.width * dpr);
        canvas.height = Math.floor(rect.height * dpr);
        ctx.scale(dpr,dpr);

        const w = rect.width, h = rect.height;
        const padL=46,padR=8,padT=10,padB=26;
        const iw=w-padL-padR, ih=h-padT-padB;

        ctx.clearRect(0,0,w,h);
        ctx.fillStyle="rgba(0,0,0,0.20)";
        ctx.fillRect(0,0,w,h);

        let minV=Infinity,maxV=-Infinity;
        for(const s of seriesList){
          for(const p of s.data){ minV=Math.min(minV,p.v); maxV=Math.max(maxV,p.v); }
        }
        const range=(maxV-minV)||1;
        minV -= range*0.08; maxV += range*0.08;

        const n = seriesList[0]?.data.length || 0;
        const x = (i)=> padL + (i/(n-1))*iw;
        const y = (v)=> padT + (1-(v-minV)/(maxV-minV))*ih;

        // grid
        ctx.strokeStyle="rgba(255,255,255,0.08)";
        ctx.lineWidth=1;
        for(let i=0;i<=5;i++){
          const yy=padT+(i/5)*ih;
          ctx.beginPath(); ctx.moveTo(padL,yy); ctx.lineTo(padL+iw,yy); ctx.stroke();
        }

        // y labels
        ctx.fillStyle="rgba(215,231,226,0.75)";
        ctx.font="12px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial";
        for(let i=0;i<=5;i++){
          const v=maxV-(i/5)*(maxV-minV);
          const yy=padT+(i/5)*ih;
          ctx.fillText(v.toFixed(2), 6, yy+4);
        }

        // lines
        for(const s of seriesList){
          ctx.strokeStyle=s.color;
          ctx.lineWidth=1.6;
          ctx.beginPath();
          for(let i=0;i<n;i++){
            const px=x(i), py=y(s.data[i].v);
            if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
          }
          ctx.stroke();
        }

        // date labels
        const first=seriesList[0].data[0]?.date || "";
        const last=seriesList[0].data[n-1]?.date || "";
        ctx.fillStyle="rgba(215,231,226,0.70)";
        ctx.fillText(first, padL, h-8);
        ctx.fillText(last, w-110, h-8);
      }

      function todayKey(){
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,"0");
        const day = String(d.getDate()).padStart(2,"0");
        return `${y}-${m}-${day}`;
      }

      async function loadData(){
        // cache (1 day)
        const cached = localStorage.getItem(CACHE_KEY);
        if(cached){
          try{
            const obj = JSON.parse(cached);
            if(obj && obj.dateKey === todayKey() && obj.payload){
              return obj.payload;
            }
          }catch{}
        }

        setStatus("Fetching sector data from TwelveData...");
        const seriesMap = {};
        seriesMap[BASE] = await fetchTD(BASE);

        // serial fetch to avoid rate issues (稳定)
        for(const s of SECTORS){
          seriesMap[s.t] = await fetchTD(s.t);
        }

        const payload = seriesMap;
        localStorage.setItem(CACHE_KEY, JSON.stringify({ dateKey: todayKey(), payload }));
        return payload;
      }

      async function main(){
        try{
          setStatus("Loading sector data...");
          const seriesMap = await loadData();
          const { aligned } = alignByDate(seriesMap);
          const spy = aligned[BASE];

          const seriesList = [];
          const changes = [];
          let ci=0;

          for(const s of SECTORS){
            const sec = aligned[s.t];
            const idx = buildRatioIndex(sec, spy);
            seriesList.push({ t:s.t, label:s.label, data: idx, color: COLORS[ci % COLORS.length] });
            ci++;

            const n = idx.length;
            if(n > RANK_WINDOW){
              const last = idx[n-1].v;
              const prev = idx[n-1-RANK_WINDOW].v;
              changes.push({ t:s.t, label:s.label, chg: pctChange(last, prev) });
            }
          }

          renderTopBottom(changes);
          drawChart(seriesList);
          setStatus("Updated.");
        }catch(e){
          console.error(e);
          setStatus("Failed to load sector data (check Console).");
          $("top3").innerHTML = "";
          $("bottom3").innerHTML = "";
        }
      }

      window.addEventListener("resize", () => { main(); });
      document.addEventListener("DOMContentLoaded", main);
    })();
  </script>
</body>
</html>