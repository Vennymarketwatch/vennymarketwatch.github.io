<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Market Dashboard</title>

  <style>
    :root{
      --bg:#0b0f10;
      --card:rgba(255,255,255,0.04);
      --border:rgba(255,255,255,0.12);
      --mint:#8fffe2;
      --text:#d7e7e2;
      --muted:rgba(215,231,226,0.65);
      --bad:#ff6b6b;
      --good:#43f5c2;
    }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    }
    .container{max-width:1250px;margin:0 auto;padding:28px 16px 70px;}
    h1{text-align:center;color:var(--mint);margin:8px 0;font-size:44px;letter-spacing:.5px;}
    .subtitle{text-align:center;margin:0 0 22px;color:var(--muted);}
    .section{
      margin:16px 0;padding:18px;border-radius:18px;background:var(--card);
      border:1px solid var(--border);box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .section h2{margin:0 0 12px;font-size:26px;color:#e9fffa;text-align:center;}

    /* Picks */
    .pager{display:flex;gap:12px;align-items:center;justify-content:center;margin:10px 0 16px;flex-wrap:wrap;}
    .pager button{
      padding:8px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06);color:#d8fff2;cursor:pointer;
    }
    .pager button:disabled{opacity:.4;cursor:not-allowed;}
    .charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    .chart-card{
      border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);padding:10px;
    }
    .chart-title{display:flex;justify-content:space-between;align-items:center;font-weight:800;margin:0 0 8px;color:var(--mint);}
    .chart-box{
      width:100%;
      height:360px;
      position:relative;
      border-radius:12px;
      overflow:hidden;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
    }
    .chart-box iframe{width:100% !important;height:100% !important;display:block;}

    /* Macro */
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px;}

    /* Sector Strength */
    .sector-wrap{display:grid;grid-template-columns:1.25fr .75fr;gap:14px;align-items:start;}
    .sector-card{
      border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);padding:12px;
    }
    .sector-meta{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;color:var(--muted);font-size:13px;margin-top:8px;}
    .sector-canvas{
      width:100%;height:420px;display:block;border-radius:12px;background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.08);
    }
    .rank-title{font-weight:800;color:#e9fffa;margin:0 0 8px;text-align:center;}
    .rank-box{display:grid;grid-template-columns:1fr;gap:10px;}
    .rank-list{border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px 12px;background:rgba(0,0,0,.18);}
    .rank-list h3{margin:0 0 8px;font-size:14px;color:#e9fffa;text-align:left;}
    .rank-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,.10);font-size:13px;}
    .rank-item:last-child{border-bottom:none;}
    .pos{color:var(--good);font-weight:700;}
    .neg{color:var(--bad);font-weight:700;}

    @media (max-width:980px){
      .charts-grid{grid-template-columns:1fr;}
      .two-col{grid-template-columns:1fr;}
      .sector-wrap{grid-template-columns:1fr;}
      .chart-box{height:420px;}
      .sector-canvas{height:420px;}
      h1{font-size:34px;}
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Market Dashboard</h1>
    <div class="subtitle">Daily scan picks + sector relative strength + macro snapshot</div>

    <!-- ===== Sector Relative Strength ===== -->
    <div class="section">
      <h2>Sector Relative Strength (Sector / SPY)</h2>
      <div class="sector-wrap">
        <div class="sector-card">
          <canvas id="sectorCanvas" class="sector-canvas"></canvas>
          <div class="sector-meta">
            <span id="sectorStatus">Loading sector data...</span>
            <span>Lookback: <b>~120 trading days</b></span>
            <span>Ranking window: <b>5 trading days</b></span>
          </div>
        </div>

        <div class="sector-card">
          <div class="rank-title">Top / Bottom Sectors (5D vs SPY)</div>
          <div class="rank-box">
            <div class="rank-list">
              <h3>Top 3</h3>
              <div id="top3"></div>
            </div>
            <div class="rank-list">
              <h3>Bottom 3</h3>
              <div id="bottom3"></div>
            </div>
          </div>
          <div class="sector-meta" style="justify-content:flex-start;margin-top:10px;">
            <span style="opacity:.85">Method: compute (Sector/SPY) index, rank by 5D % change.</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Picks ===== -->
    <div class="section">
      <h2>My Picks Charts (4 per page)</h2>
      <div class="pager">
        <button id="prevPage" type="button">Prev</button>
        <div id="pageInfo">Loading picks.json...</div>
        <button id="nextPage" type="button">Next</button>
      </div>
      <div id="chartsGrid" class="charts-grid"></div>
    </div>

    <!-- ===== Macro ===== -->
    <div class="section">
      <h2>Macro Snapshot</h2>
      <div class="two-col">
        <div class="chart-card">
          <div class="chart-title"><span>Fed Funds Rate</span><span style="opacity:.75;font-weight:600;">1D</span></div>
          <div class="chart-box" id="fedFunds"></div>
        </div>
        <div class="chart-card">
          <div class="chart-title"><span>US CPI</span><span style="opacity:.75;font-weight:600;">1D</span></div>
          <div class="chart-box" id="cpi"></div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Market Heatmap</h2>
      <div id="heatmap"></div>
    </div>
  </div>

  <!-- ===== TradingView helpers ===== -->
  <script>
    // EMA studies (TradingView built-in study id)
    // If your TV region ever fails to load studies, remove "studies" first (rare).
    const EMA_STUDIES = [
      { id: "MAExp@tv-basicstudies", inputs: { length: 20 } },
      { id: "MAExp@tv-basicstudies", inputs: { length: 60 } },
      { id: "MAExp@tv-basicstudies", inputs: { length: 120 } },
      { id: "MAExp@tv-basicstudies", inputs: { length: 250 } },
    ];

    function mountTVAdvancedChart(containerEl, symbol, height=360){
      const s = document.createElement("script");
      s.src = "https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js";
      s.async = true;
      s.textContent = JSON.stringify({
        width: "100%",
        height: "100%",
        symbol: symbol,
        interval: "D",
        timezone: "Etc/UTC",
        theme: "dark",
        style: "1",
        locale: "en",
        hide_top_toolbar: true,
        hide_legend: true,
        allow_symbol_change: false,
        save_image: false,
        withdateranges: false,
        studies: EMA_STUDIES
      });
      containerEl.style.height = height + "px";
      containerEl.appendChild(s);
    }

    function mountTVHeatmap(containerEl){
      const s = document.createElement("script");
      s.src = "https://s3.tradingview.com/external-embedding/embed-widget-stock-heatmap.js";
      s.async = true;
      s.textContent = JSON.stringify({
        dataSource: "SPX500",
        blockSize: "market_cap_basic",
        blockColor: "change",
        locale: "en",
        colorTheme: "dark",
        hasTopBar: false,
        isDataSetEnabled: false,
        isZoomEnabled: true,
        hasSymbolTooltip: true,
        width: "100%",
        height: 400
      });
      containerEl.appendChild(s);
    }

    document.addEventListener("DOMContentLoaded", () => {
      mountTVAdvancedChart(document.getElementById("fedFunds"), "FRED:EFFR", 320);
      mountTVAdvancedChart(document.getElementById("cpi"), "ECONOMICS:USCPI", 320);
      mountTVHeatmap(document.getElementById("heatmap"));
    });
  </script>

  <!-- ===== Picks (4 per page) ===== -->
  <script>
    (function(){
      const PAGE_SIZE = 4;
      let allTickers = [];
      let page = 1;

      function $(id){ return document.getElementById(id); }
      function clearNode(el){ while(el && el.firstChild) el.removeChild(el.firstChild); }

      function renderPage(){
        const grid = $("chartsGrid");
        const info = $("pageInfo");
        const prevBtn = $("prevPage");
        const nextBtn = $("nextPage");
        if(!grid || !info || !prevBtn || !nextBtn) return;

        const totalPages = Math.max(1, Math.ceil(allTickers.length / PAGE_SIZE));
        page = Math.min(Math.max(1, page), totalPages);

        const start = (page - 1) * PAGE_SIZE;
        const items = allTickers.slice(start, start + PAGE_SIZE);

        info.textContent = `Page ${page} / ${totalPages} | Total: ${allTickers.length}`;
        prevBtn.disabled = (page <= 1);
        nextBtn.disabled = (page >= totalPages);

        clearNode(grid);

        items.forEach(t => {
          const card = document.createElement("div");
          card.className = "chart-card";

          const title = document.createElement("div");
          title.className = "chart-title";
          title.innerHTML = `<span>${t}</span><span style="opacity:.75;font-weight:600;">1D</span>`;

          const box = document.createElement("div");
          box.className = "chart-box";

          card.appendChild(title);
          card.appendChild(box);
          grid.appendChild(card);

          mountTVAdvancedChart(box, t, 360);
        });
      }

      async function loadPicks(){
        try{
          const r = await fetch("./picks.json?v=" + Date.now());
          const j = await r.json();
          const results = j.results || [];
          allTickers = results.map(x => (typeof x === "string" ? x : x.ticker)).filter(Boolean);
          renderPage();
        }catch(e){
          console.error(e);
          const info = $("pageInfo");
          if(info) info.textContent = "Failed to load picks.json (check Console).";
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        $("prevPage").addEventListener("click", () => { page--; renderPage(); });
        $("nextPage").addEventListener("click", () => { page++; renderPage(); });
        loadPicks();
      });
    })();
  </script>

  <!-- ===== Sector Relative Strength (load local sectors.json) ===== -->
  <script>
    (function(){
      const COLORS = [
        "#7BDFF2","#B2F7EF","#EFF7F6","#F7D6E0","#F2B5D4",
        "#F8C0C8","#C3FBD8","#B5F2E2","#A9DEF9","#E4C1F9",
        "#FFCAD4","#D4A5A5"
      ];

      function $(id){ return document.getElementById(id); }
      function setStatus(msg){ $("sectorStatus").textContent = msg; }

      function renderTopBottom(top3, bottom3){
        function rowHTML(x){
          const cls = x.chg >= 0 ? "pos" : "neg";
          const pct = (x.chg * 100).toFixed(2) + "%";
          return `<div class="rank-item"><span>${x.t} <span style="opacity:.7">(${x.label})</span></span><span class="${cls}">${pct}</span></div>`;
        }
        $("top3").innerHTML = (top3 || []).map(rowHTML).join("") || "<div style='opacity:.7'>No data</div>";
        $("bottom3").innerHTML = (bottom3 || []).map(rowHTML).join("") || "<div style='opacity:.7'>No data</div>";
      }

      function drawChart(seriesList){
        const canvas = $("sectorCanvas");
        const ctx = canvas.getContext("2d");
        const rect = canvas.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        canvas.width = Math.floor(rect.width * dpr);
        canvas.height = Math.floor(rect.height * dpr);
        ctx.scale(dpr,dpr);

        const w = rect.width, h = rect.height;
        const padL=46,padR=8,padT=10,padB=26;
        const iw=w-padL-padR, ih=h-padT-padB;

        ctx.clearRect(0,0,w,h);
        ctx.fillStyle="rgba(0,0,0,0.20)";
        ctx.fillRect(0,0,w,h);

        let minV=Infinity,maxV=-Infinity;
        for(const s of seriesList){
          for(const p of s.data){ minV=Math.min(minV,p.v); maxV=Math.max(maxV,p.v); }
        }
        const range=(maxV-minV)||1;
        minV -= range*0.08; maxV += range*0.08;

        const n = seriesList[0]?.data.length || 0;
        if(n < 2) return;

        const x = (i)=> padL + (i/(n-1))*iw;
        const y = (v)=> padT + (1-(v-minV)/(maxV-minV))*ih;

        // grid
        ctx.strokeStyle="rgba(255,255,255,0.08)";
        ctx.lineWidth=1;
        for(let i=0;i<=5;i++){
          const yy=padT+(i/5)*ih;
          ctx.beginPath(); ctx.moveTo(padL,yy); ctx.lineTo(padL+iw,yy); ctx.stroke();
        }

        // y labels
        ctx.fillStyle="rgba(215,231,226,0.75)";
        ctx.font="12px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial";
        for(let i=0;i<=5;i++){
          const v=maxV-(i/5)*(maxV-minV);
          const yy=padT+(i/5)*ih;
          ctx.fillText(v.toFixed(2), 6, yy+4);
        }

        // lines
        for(const s of seriesList){
          ctx.strokeStyle=s.color;
          ctx.lineWidth=1.6;
          ctx.beginPath();
          for(let i=0;i<n;i++){
            const px=x(i), py=y(s.data[i].v);
            if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
          }
          ctx.stroke();
        }

        // dates
        const first=seriesList[0].data[0]?.date || "";
        const last=seriesList[0].data[n-1]?.date || "";
        ctx.fillStyle="rgba(215,231,226,0.70)";
        ctx.fillText(first, padL, h-8);
        ctx.fillText(last, w-110, h-8);
      }

      async function main(){
        try{
          setStatus("Loading sectors.json...");
          const r = await fetch("./sectors.json?v=" + Date.now());
          const j = await r.json();

          const seriesList = (j.series || []).map((s, i) => ({
            t: s.t,
            label: s.label,
            data: s.data,
            color: COLORS[i % COLORS.length]
          }));

          renderTopBottom(j.top3, j.bottom3);
          drawChart(seriesList);
          setStatus("Updated.");
        }catch(e){
          console.error(e);
          setStatus("Failed to load sectors.json (run scan.py to generate it).");
          $("top3").innerHTML = "";
          $("bottom3").innerHTML = "";
        }
      }

      window.addEventListener("resize", main);
      document.addEventListener("DOMContentLoaded", main);
    })();
  </script>
</body>
</html>